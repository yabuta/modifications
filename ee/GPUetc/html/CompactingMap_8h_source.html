<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>structures/CompactingMap.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>structures/CompactingMap.h</h1><a href="CompactingMap_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* This file is part of VoltDB.</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2008-2014 VoltDB Inc.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software: you can redistribute it and/or modify</span>
<a name="l00005"></a>00005 <span class="comment"> * it under the terms of the GNU Affero General Public License as</span>
<a name="l00006"></a>00006 <span class="comment"> * published by the Free Software Foundation, either version 3 of the</span>
<a name="l00007"></a>00007 <span class="comment"> * License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment"> * GNU Affero General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * You should have received a copy of the GNU Affero General Public License</span>
<a name="l00015"></a>00015 <span class="comment"> * along with VoltDB.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00016"></a>00016 <span class="comment"> */</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#ifndef COMPACTINGMAP_H_</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span><span class="preprocessor">#define COMPACTINGMAP_H_</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="ContiguousAllocator_8h.html">ContiguousAllocator.h</a>&quot;</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;utility&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;limits&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a><a class="code" href="CompactingMap_8h.html#ac21bb2d05c29ed1bdd0df2d7d0c43954">00029</a> <span class="keyword">typedef</span> u_int32_t <a class="code" href="CompactingMap_8h.html#ac21bb2d05c29ed1bdd0df2d7d0c43954">NodeCount</a>;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#ifndef SUBCTMAX</span>
<a name="l00032"></a><a class="code" href="CompactingMap_8h.html#af2971340ad4ae40c4793a3f1429e3bec">00032</a> <span class="preprocessor"></span><span class="preprocessor">#define SUBCTMAX INT32_MAX</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00035"></a>00035 <span class="preprocessor">#ifndef INVALIDCT</span>
<a name="l00036"></a><a class="code" href="CompactingMap_8h.html#a5fb2075a127575b77776ed5139fa6cc1">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define INVALIDCT 0</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 <span class="comment">// MAXPOINTER will be reinterpret_cast back to UINTPTR_MAX</span>
<a name="l00040"></a>00040 <span class="preprocessor">#ifndef MAXPOINTER</span>
<a name="l00041"></a><a class="code" href="CompactingMap_8h.html#a828aaca8426114ee5484d256eb3c1b7c">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXPOINTER (reinterpret_cast&lt;const void *&gt;(UINTPTR_MAX))</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>
<a name="l00044"></a>00044 <span class="keyword">namespace </span>voltdb {
<a name="l00045"></a>00045 
<a name="l00046"></a><a class="code" href="namespacevoltdb.html#a8ba509eb9b2881bb214078918e4dbde4">00046</a> <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="namespacevoltdb.html#a876c55e558af5a641d092fa27fd846d9">setPointerValue</a>(T&amp; t, <span class="keyword">const</span> <span class="keywordtype">void</span> * v) {}
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="comment">// the template for KeyTypes don&apos;t contain a pointer to the tuple</span>
<a name="l00049"></a>00049 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> Key, <span class="keyword">typename</span> Data = const <span class="keywordtype">void</span>*&gt;
<a name="l00050"></a><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html">00050</a> <span class="keyword">class </span><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html">NormalKeyValuePair</a> : <span class="keyword">public</span> std::pair&lt;Key, Data&gt; {
<a name="l00051"></a>00051 <span class="keyword">public</span>:
<a name="l00052"></a><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a8b628ef770ebda1ee35fc9139f135a27">00052</a>     <a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a8b628ef770ebda1ee35fc9139f135a27">NormalKeyValuePair</a>() {}
<a name="l00053"></a><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a338ba6570f1c04020cdab5efc8438efa">00053</a>     <a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a338ba6570f1c04020cdab5efc8438efa">NormalKeyValuePair</a>(<span class="keyword">const</span> Key &amp;key, <span class="keyword">const</span> Data &amp;value) : std::pair&lt;Key, Data&gt;(key, value) {}
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a057b732e60cf997e07cf124e55802ffd">00055</a>     <span class="keyword">const</span> Key&amp; <a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a057b732e60cf997e07cf124e55802ffd">getKey</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> std::pair&lt;Key, Data&gt;::first; }
<a name="l00056"></a><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a99992799bbf555bbeb2fd83d7f4c36fc">00056</a>     <span class="keyword">const</span> Data&amp; <a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a99992799bbf555bbeb2fd83d7f4c36fc">getValue</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> std::pair&lt;Key, Data&gt;::second; }
<a name="l00057"></a><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a0c6588792f12e4d266d12c1c77bb65bf">00057</a>     <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a0c6588792f12e4d266d12c1c77bb65bf">setKey</a>(<span class="keyword">const</span> Key &amp;key) { std::pair&lt;Key, Data&gt;::first = key; }
<a name="l00058"></a><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a52a3ffb8c991c5fee41783f2cc273372">00058</a>     <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a52a3ffb8c991c5fee41783f2cc273372">setValue</a>(<span class="keyword">const</span> Data &amp;value) { std::pair&lt;Key, Data&gt;::second = value; }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     <span class="comment">// This function does nothing, and is only to offer the same API as PointerKeyValuePair.</span>
<a name="l00061"></a><a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a2ff9979442e8d219f15ee1cdb58a13a9">00061</a>     <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="classvoltdb_1_1NormalKeyValuePair.html#a2ff9979442e8d219f15ee1cdb58a13a9">setPointerValue</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *value) { <span class="keywordflow">return</span> NULL; }
<a name="l00062"></a>00062 };
<a name="l00063"></a>00063 
<a name="l00094"></a>00094 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank=false&gt;
<a name="l00095"></a><a class="code" href="classvoltdb_1_1CompactingMap.html">00095</a> <span class="keyword">class </span><a class="code" href="classvoltdb_1_1CompactingMap.html">CompactingMap</a> {
<a name="l00096"></a>00096     <span class="keyword">typedef</span> <span class="keyword">typename</span> KeyValuePair::first_type Key;
<a name="l00097"></a>00097     <span class="keyword">typedef</span> <span class="keyword">typename</span> KeyValuePair::second_type Data;
<a name="l00098"></a>00098 <span class="keyword">protected</span>:
<a name="l00099"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">00099</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a> = 0;
<a name="l00100"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">00100</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a> = 1;
<a name="l00101"></a>00101 
<a name="l00102"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">00102</a>     <span class="keyword">struct </span><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> {
<a name="l00103"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">00103</a>         KeyValuePair <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>;
<a name="l00104"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">00104</a>         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00105"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">00105</a>         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00106"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">00106</a>         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00107"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">00107</a>         <span class="keywordtype">char</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a>;
<a name="l00108"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">00108</a>         <a class="code" href="CompactingMap_8h.html#ac21bb2d05c29ed1bdd0df2d7d0c43954">NodeCount</a> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a>;
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">00110</a>         <span class="keyword">const</span> Key &amp;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>.getKey(); };
<a name="l00111"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac77ff2f6c96d61811937cb342d55a096">00111</a>         <span class="keyword">const</span> Data &amp;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac77ff2f6c96d61811937cb342d55a096">value</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>.getValue(); };
<a name="l00112"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a6ec4909fe577adf6f3973d3d7dbd36e2">00112</a>         <span class="keywordtype">void</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a6ec4909fe577adf6f3973d3d7dbd36e2">setKey</a>(<span class="keyword">const</span> Key &amp;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac77ff2f6c96d61811937cb342d55a096">value</a>) { <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>.setKey(value); }
<a name="l00113"></a><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac35c23a4cfb14eed02b1d4350313b911">00113</a>         <span class="keywordtype">void</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac35c23a4cfb14eed02b1d4350313b911">setValue</a>(<span class="keyword">const</span> Data &amp;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac77ff2f6c96d61811937cb342d55a096">value</a>) { <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>.setValue(value); }
<a name="l00114"></a>00114     };
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">00116</a>     int64_t <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>;
<a name="l00117"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">00117</a>     TreeNode *<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>;
<a name="l00118"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">00118</a>     <a class="code" href="classvoltdb_1_1ContiguousAllocator.html">ContiguousAllocator</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>;
<a name="l00119"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#ac2e95d8474d0825541a41e3ab7a3d519">00119</a>     <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ac2e95d8474d0825541a41e3ab7a3d519">m_unique</a>;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <span class="comment">// rather than NULL, most tree pointers that don&apos;t point</span>
<a name="l00122"></a>00122     <span class="comment">// to nodes point to NIL. This is taken from Cormen and</span>
<a name="l00123"></a>00123     <span class="comment">// makes some aspects easier to deal with.</span>
<a name="l00124"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">00124</a>     TreeNode <a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>;
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="comment">// templated comparison function object</span>
<a name="l00127"></a>00127     <span class="comment">// follows STL conventions</span>
<a name="l00128"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">00128</a>     Compare <a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="keyword">public</span>:
<a name="l00131"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">00131</a>     <span class="keyword">class </span><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a> {
<a name="l00132"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a775f5e6d40a4b32aadbdef8c1345d733">00132</a>         <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classvoltdb_1_1CompactingMap.html">CompactingMap</a>&lt;KeyValuePair, Compare, hasRank&gt;;
<a name="l00133"></a>00133     <span class="keyword">protected</span>:
<a name="l00134"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">00134</a>         <span class="keyword">const</span> <a class="code" href="classvoltdb_1_1CompactingMap.html">CompactingMap</a> *<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>;
<a name="l00135"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">00135</a>         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>;
<a name="l00136"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae4421354ad75e8fce67bad396ae97343">00136</a>         <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae4421354ad75e8fce67bad396ae97343">iterator</a>(<span class="keyword">const</span> <a class="code" href="classvoltdb_1_1CompactingMap.html">CompactingMap</a> *m, <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>* x) : <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>(m), <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>(x) {}
<a name="l00137"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#af85fabc7a69a068a7878e40364c4a2de">00137</a>         <span class="keyword">const</span> KeyValuePair &amp;<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#af85fabc7a69a068a7878e40364c4a2de">pair</a>() { <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>; }
<a name="l00138"></a>00138     <span class="keyword">public</span>:
<a name="l00139"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae32a3b2e799f39cecbe1878a5f653855">00139</a>         <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae32a3b2e799f39cecbe1878a5f653855">iterator</a>() : <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>(NULL), <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>(NULL) {}
<a name="l00140"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#aa8862918a87ee45b193ae130eba357ea">00140</a>         <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#aa8862918a87ee45b193ae130eba357ea">iterator</a>(<span class="keyword">const</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a> &amp;iter) : <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>(iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>), <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>(iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>) {}
<a name="l00141"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a969041c693fff058421f5d700442e631">00141</a>         <span class="keyword">const</span> Key &amp;<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a969041c693fff058421f5d700442e631">key</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>(); }
<a name="l00142"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a99185df3b8d81eb1ec75f88a2faebd1d">00142</a>         <span class="keyword">const</span> Data &amp;<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a99185df3b8d81eb1ec75f88a2faebd1d">value</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac77ff2f6c96d61811937cb342d55a096">value</a>(); }
<a name="l00143"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a3c572a65933bf4ccdf9ab3d6df00d60e">00143</a>         <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a3c572a65933bf4ccdf9ab3d6df00d60e">setValue</a>(<span class="keyword">const</span> Data &amp;<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a99185df3b8d81eb1ec75f88a2faebd1d">value</a>) { <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>.setValue(value); }
<a name="l00144"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#aad6c3c8f3e8b937ad90a90e1efa25f4a">00144</a>         <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#aad6c3c8f3e8b937ad90a90e1efa25f4a">moveNext</a>() { <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a> = <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>-&gt;<a class="code" href="classvoltdb_1_1CompactingMap.html#a10e730998a390611e5f83ce33b64bbcc">successor</a>(<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>); }
<a name="l00145"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac59e4a1b7a76d507947c87c85b87c77a">00145</a>         <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac59e4a1b7a76d507947c87c85b87c77a">movePrev</a>() { <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a> = <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>-&gt;<a class="code" href="classvoltdb_1_1CompactingMap.html#a737a70666b78216bff6531b76d43a1d4">predecessor</a>(<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>); }
<a name="l00146"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a2d7048d74e611858068ebc76d6dba7e2">00146</a>         <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a2d7048d74e611858068ebc76d6dba7e2">isEnd</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> ((!<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>) || (<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a> == &amp;(<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac141d54bcc54fd79af77a1fd06868c75">m_map</a>-&gt;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>))); }
<a name="l00147"></a><a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#afb66c0e169ba9a1f5921268c3fe20728">00147</a>         <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#afb66c0e169ba9a1f5921268c3fe20728">equals</a>(<span class="keyword">const</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a> &amp;iter)<span class="keyword"> const </span>{
<a name="l00148"></a>00148             <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a2d7048d74e611858068ebc76d6dba7e2">isEnd</a>()) {
<a name="l00149"></a>00149                 <span class="keywordflow">return</span> iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a2d7048d74e611858068ebc76d6dba7e2">isEnd</a>();
<a name="l00150"></a>00150             }
<a name="l00151"></a>00151             <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a> == iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>;
<a name="l00152"></a>00152         }
<a name="l00153"></a>00153     };
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <a class="code" href="classvoltdb_1_1CompactingMap.html#a66b699c9ddc5e6fb4142a1f1ceda469a">CompactingMap</a>(<span class="keywordtype">bool</span> unique, Compare comper);
<a name="l00156"></a>00156     <a class="code" href="classvoltdb_1_1CompactingMap.html#a826d1f08124c27e44b84803ca68f5458">~CompactingMap</a>();
<a name="l00157"></a>00157 
<a name="l00158"></a>00158     <span class="comment">// TODO: remove this. But two eecheck depend on this.</span>
<a name="l00159"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#ae5df238af681bd117ea66ea4b5c939d4">00159</a>     <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ae5df238af681bd117ea66ea4b5c939d4">insert</a>(std::pair&lt;Key, Data&gt; value) { <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ae5df238af681bd117ea66ea4b5c939d4">insert</a>(value.first, value.second); };
<a name="l00160"></a>00160     <span class="comment">// A syntactically convenient analog to CompactingHashTable&apos;s insert function</span>
<a name="l00161"></a>00161     <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ae5df238af681bd117ea66ea4b5c939d4">insert</a>(<span class="keyword">const</span> Key &amp;key, <span class="keyword">const</span> Data &amp;data);
<a name="l00162"></a>00162     <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">erase</a>(<span class="keyword">const</span> Key &amp;key);
<a name="l00163"></a>00163     <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">erase</a>(iterator &amp;iter);
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a32119143308ef660ca4af38b49b2eb1e">00165</a>     iterator <a class="code" href="classvoltdb_1_1CompactingMap.html#a32119143308ef660ca4af38b49b2eb1e">find</a>(<span class="keyword">const</span> Key &amp;key)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> iterator(<span class="keyword">this</span>, <a class="code" href="classvoltdb_1_1CompactingMap.html#a85737c90e336d640a1af52d5c8e9f1e9">lookup</a>(key)); }
<a name="l00166"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#aecab6a57563265f484e0840da60ffde8">00166</a>     iterator <a class="code" href="classvoltdb_1_1CompactingMap.html#aecab6a57563265f484e0840da60ffde8">findRank</a>(int64_t ith)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> iterator(<span class="keyword">this</span>, <a class="code" href="classvoltdb_1_1CompactingMap.html#a70781434c7629604c4da1a89932db1dd">lookupRank</a>(ith)); }
<a name="l00167"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a7da2e422ab4355b053d6c0026255043f">00167</a>     int64_t <a class="code" href="classvoltdb_1_1CompactingMap.html#a7da2e422ab4355b053d6c0026255043f">size</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>; }
<a name="l00168"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a600945ade4c83c0afd28653a4de5e692">00168</a>     iterator <a class="code" href="classvoltdb_1_1CompactingMap.html#a600945ade4c83c0afd28653a4de5e692">begin</a>()<span class="keyword"> const</span>
<a name="l00169"></a>00169 <span class="keyword">    </span>{
<a name="l00170"></a>00170         <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a> == 0) {
<a name="l00171"></a>00171             <span class="keywordflow">return</span> iterator();
<a name="l00172"></a>00172         }
<a name="l00173"></a>00173         <span class="keywordflow">return</span> iterator(<span class="keyword">this</span>, <a class="code" href="classvoltdb_1_1CompactingMap.html#a384b656093b2844c6ec805c18fb05ade">minimum</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>));
<a name="l00174"></a>00174     }
<a name="l00175"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#afcd566fdc7e5543b205a99beb44dc031">00175</a>     iterator <a class="code" href="classvoltdb_1_1CompactingMap.html#afcd566fdc7e5543b205a99beb44dc031">rbegin</a>()<span class="keyword"> const </span>{
<a name="l00176"></a>00176         <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a> == 0) {
<a name="l00177"></a>00177             <span class="keywordflow">return</span> iterator();
<a name="l00178"></a>00178         }
<a name="l00179"></a>00179         <span class="keywordflow">return</span> iterator(<span class="keyword">this</span>, <a class="code" href="classvoltdb_1_1CompactingMap.html#a72dcd8315ad6c09cb34a892962eec3da">maximum</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>));
<a name="l00180"></a>00180     }
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     iterator <a class="code" href="classvoltdb_1_1CompactingMap.html#a535ea3a93d6fe09cda5dbe2802f729bf">lowerBound</a>(<span class="keyword">const</span> Key &amp;key) <span class="keyword">const</span>;
<a name="l00183"></a>00183     iterator <a class="code" href="classvoltdb_1_1CompactingMap.html#ab189d7e2235fb3d4f258d466025c11b0">upperBound</a>(<span class="keyword">const</span> Key &amp;key) <span class="keyword">const</span>;
<a name="l00184"></a>00184 
<a name="l00185"></a>00185     std::pair&lt;iterator, iterator&gt; <a class="code" href="classvoltdb_1_1CompactingMap.html#a2c45537d1a3f66a05f5a8dad4ef05f3e">equalRange</a>(<span class="keyword">const</span> Key &amp;key) <span class="keyword">const</span>;
<a name="l00186"></a>00186 
<a name="l00187"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a70e4bb64b7ef7c7ec869a701929150b7">00187</a>     <span class="keywordtype">size_t</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a70e4bb64b7ef7c7ec869a701929150b7">bytesAllocated</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#ac073cebc685b24283e07e13b0d209915">bytesAllocated</a>(); }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     <span class="comment">// TODO(xin): later rename it to rankLower</span>
<a name="l00190"></a>00190     <span class="comment">// Must pass a key that already in map, or else return -1</span>
<a name="l00191"></a>00191     int64_t <a class="code" href="classvoltdb_1_1CompactingMap.html#ae1cf32db2c633effc23a95cb3d107b9d">rankAsc</a>(<span class="keyword">const</span> Key&amp; key) <span class="keyword">const</span>;
<a name="l00192"></a>00192     int64_t <a class="code" href="classvoltdb_1_1CompactingMap.html#a796583934a55cd62e6a238bf9299e253">rankUpper</a>(<span class="keyword">const</span> Key&amp; key) <span class="keyword">const</span>;
<a name="l00193"></a>00193 
<a name="l00197"></a>00197     <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ad64f17e1e919aa57f8fcd255a3d25ec5">verify</a>() <span class="keyword">const</span>;
<a name="l00198"></a>00198     <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a9d70dd20475e0a5b8bc3f786dd270da7">verifyRank</a>() <span class="keyword">const</span>;
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="keyword">protected</span>:
<a name="l00201"></a>00201     <span class="comment">// main internal functions</span>
<a name="l00202"></a>00202     <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">erase</a>(TreeNode *z);
<a name="l00203"></a>00203     TreeNode *<a class="code" href="classvoltdb_1_1CompactingMap.html#a85737c90e336d640a1af52d5c8e9f1e9">lookup</a>(<span class="keyword">const</span> Key &amp;key) <span class="keyword">const</span>;
<a name="l00204"></a>00204     TreeNode *<a class="code" href="classvoltdb_1_1CompactingMap.html#a70781434c7629604c4da1a89932db1dd">lookupRank</a>(int64_t ith) <span class="keyword">const</span>;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="keyword">inline</span> int64_t <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(<span class="keyword">const</span> TreeNode* x) <span class="keyword">const</span>;
<a name="l00207"></a>00207     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#acd81c7053dea04eac6a8597ccce9af93">incSubct</a>(TreeNode* x);
<a name="l00208"></a>00208     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a29e437ee65024d104bd05b5bb61e5abd">decSubct</a>(TreeNode* x);
<a name="l00209"></a>00209     <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#acd9df75422f296b0427720969a70392b">updateSubct</a>(TreeNode* x);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">// static for iterator use</span>
<a name="l00212"></a>00212     TreeNode *<a class="code" href="classvoltdb_1_1CompactingMap.html#a384b656093b2844c6ec805c18fb05ade">minimum</a>(<span class="keyword">const</span> TreeNode *subRoot) <span class="keyword">const</span>;
<a name="l00213"></a>00213     TreeNode *<a class="code" href="classvoltdb_1_1CompactingMap.html#a72dcd8315ad6c09cb34a892962eec3da">maximum</a>(<span class="keyword">const</span> TreeNode *subRoot) <span class="keyword">const</span>;
<a name="l00214"></a>00214     TreeNode *<a class="code" href="classvoltdb_1_1CompactingMap.html#a10e730998a390611e5f83ce33b64bbcc">successor</a>(<span class="keyword">const</span> TreeNode *x) <span class="keyword">const</span>;
<a name="l00215"></a>00215     TreeNode *<a class="code" href="classvoltdb_1_1CompactingMap.html#a737a70666b78216bff6531b76d43a1d4">predecessor</a>(<span class="keyword">const</span> TreeNode *x) <span class="keyword">const</span>;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="comment">// sub functions to make the magic happen</span>
<a name="l00218"></a>00218     <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a53db1ecaa3ad20fc7c7042aef675fc46">leftRotate</a>(TreeNode *x);
<a name="l00219"></a>00219     <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a82b170ebd6349e0456b696d573fc27de">rightRotate</a>(TreeNode *x);
<a name="l00220"></a>00220     <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a89fadf0f0c9dac7b330bd9ba7193750d">insertFixup</a>(TreeNode *z);
<a name="l00221"></a>00221     <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a5c93710d259f1272936d4ca3f34906a1">deleteFixup</a>(TreeNode *x);
<a name="l00222"></a>00222     <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a999fc66444d2524385c94335a4b114d6">fragmentFixup</a>(TreeNode *x);
<a name="l00223"></a>00223 
<a name="l00224"></a>00224     <span class="comment">// debugging and testing methods</span>
<a name="l00225"></a>00225     <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a857c3319d8d0d7622b6df27e19ee181e">isReachableNode</a>(<span class="keyword">const</span> TreeNode* start, <span class="keyword">const</span> TreeNode *dest) <span class="keyword">const</span>;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordtype">int</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ad64f17e1e919aa57f8fcd255a3d25ec5">verify</a>(<span class="keyword">const</span> TreeNode *n) <span class="keyword">const</span>;
<a name="l00228"></a>00228     <span class="keywordtype">int</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a62e59d008a0004c15c4b2bd3ecdb648d">inOrderCounterChecking</a>(<span class="keyword">const</span> TreeNode *n) <span class="keyword">const</span>;
<a name="l00229"></a>00229     <span class="keywordtype">int</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#aaaf9eceb89360101a132154eb4cf79ca">fullCount</a>(<span class="keyword">const</span> TreeNode *n) <span class="keyword">const</span>;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a83aec764bd6dceb39a371df6c882aa33">compareKeyRegardlessOfPointer</a>(<span class="keyword">const</span> Key&amp; key, TreeNode *node) <span class="keyword">const</span>;
<a name="l00232"></a>00232 };
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00235"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a66b699c9ddc5e6fb4142a1f1ceda469a">00235</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a66b699c9ddc5e6fb4142a1f1ceda469a">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::CompactingMap</a>(<span class="keywordtype">bool</span> unique, Compare comper)
<a name="l00236"></a>00236     : m_count(0),
<a name="l00237"></a>00237       m_root(&amp;NIL),
<a name="l00238"></a>00238       m_allocator(static_cast&lt;int&gt;(sizeof(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>) - (hasRank ? 0 : sizeof(<a class="code" href="CompactingMap_8h.html#ac21bb2d05c29ed1bdd0df2d7d0c43954">NodeCount</a>))), static_cast&lt;int&gt;(10000)),
<a name="l00239"></a>00239       m_unique(unique),
<a name="l00240"></a>00240       m_comper(comper)
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242     <a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>.<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>.<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>.<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>;
<a name="l00243"></a>00243     <a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>.<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00244"></a>00244     <span class="keywordflow">if</span> (hasRank) {
<a name="l00245"></a>00245         <a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>.<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> = <a class="code" href="CompactingMap_8h.html#a5fb2075a127575b77776ed5139fa6cc1">INVALIDCT</a>;
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00250"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a826d1f08124c27e44b84803ca68f5458">00250</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a826d1f08124c27e44b84803ca68f5458">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::~CompactingMap</a>()
<a name="l00251"></a>00251 {
<a name="l00252"></a>00252     <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a> iter = <a class="code" href="classvoltdb_1_1CompactingMap.html#a600945ade4c83c0afd28653a4de5e692">begin</a>();
<a name="l00253"></a>00253     <span class="keywordflow">while</span> (!iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a2d7048d74e611858068ebc76d6dba7e2">isEnd</a>()) {
<a name="l00254"></a>00254         iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#af85fabc7a69a068a7878e40364c4a2de">pair</a>().~KeyValuePair();
<a name="l00255"></a>00255         iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#aad6c3c8f3e8b937ad90a90e1efa25f4a">moveNext</a>();
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00260"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">00260</a> <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::erase</a>(<span class="keyword">const</span> Key &amp;key)
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *node = <a class="code" href="classvoltdb_1_1CompactingMap.html#a85737c90e336d640a1af52d5c8e9f1e9">lookup</a>(key);
<a name="l00263"></a>00263     <span class="keywordflow">if</span> (node == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00264"></a>00264         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266     <a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">erase</a>(node);
<a name="l00267"></a>00267     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00271"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#aa769b715fc74cbd32c209cecbc49e6a1">00271</a> <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::erase</a>(<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a> &amp;iter)
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273     assert(iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>);
<a name="l00274"></a>00274     <a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">erase</a>(iter.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ae15fe97bac651adf759dbb36b5fe6b9f">m_node</a>);
<a name="l00275"></a>00275     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00279"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a55b74ab0349b8ebcd1cfccda747f8f89">00279</a> <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ae5df238af681bd117ea66ea4b5c939d4">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::insert</a>(<span class="keyword">const</span> Key &amp;key, <span class="keyword">const</span> Data &amp;value)
<a name="l00280"></a>00280 {
<a name="l00281"></a>00281     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00282"></a>00282         <span class="comment">// find a place to put the new node</span>
<a name="l00283"></a>00283         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>;
<a name="l00284"></a>00284         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x = <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>;
<a name="l00285"></a>00285         <span class="keywordflow">while</span> (x != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00286"></a>00286             y = x;
<a name="l00287"></a>00287             <span class="keywordtype">int</span> cmp = <a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>(key, x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>());
<a name="l00288"></a>00288             <span class="keywordflow">if</span> (cmp &lt; 0) {
<a name="l00289"></a>00289                 x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00290"></a>00290             }
<a name="l00291"></a>00291             <span class="keywordflow">else</span> {
<a name="l00292"></a>00292                 <span class="comment">// For non-unique indexes -- not really being used since unique tuple addresses</span>
<a name="l00293"></a>00293                 <span class="comment">// were added to keys -- new duplicates are (needlessly) forced to insert</span>
<a name="l00294"></a>00294                 <span class="comment">// after (to the right of) existing duplicates by falling through here.</span>
<a name="l00295"></a>00295                 <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#ac2e95d8474d0825541a41e3ab7a3d519">m_unique</a> &amp;&amp; (cmp == 0)) {
<a name="l00296"></a>00296                     <span class="comment">// Inserting exact matches fails for unique indexes.</span>
<a name="l00297"></a>00297                     <span class="comment">// Undo the optimistic bumping of subcounts done already on the way down.</span>
<a name="l00298"></a>00298                     <span class="keywordflow">if</span> (hasRank) {
<a name="l00299"></a>00299                         <span class="keywordflow">while</span> (x != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00300"></a>00300                             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00301"></a>00301                             <a class="code" href="classvoltdb_1_1CompactingMap.html#a29e437ee65024d104bd05b5bb61e5abd">decSubct</a>(x);
<a name="l00302"></a>00302                         }
<a name="l00303"></a>00303                     }
<a name="l00304"></a>00304                     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00305"></a>00305                 }
<a name="l00306"></a>00306                 x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00307"></a>00307             }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309             <span class="keywordflow">if</span> (hasRank) {
<a name="l00310"></a>00310                 <a class="code" href="classvoltdb_1_1CompactingMap.html#acd81c7053dea04eac6a8597ccce9af93">incSubct</a>(y);
<a name="l00311"></a>00311             }
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="comment">// create a new node</span>
<a name="l00315"></a>00315         <span class="keywordtype">void</span> *memory = <a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#afcbcccaf9bf98d7fd78c6d7b05f89c10">alloc</a>();
<a name="l00316"></a>00316         assert(memory);
<a name="l00317"></a>00317         <span class="comment">// placement new</span>
<a name="l00318"></a>00318         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *z = <span class="keyword">new</span>(memory) <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>();
<a name="l00319"></a>00319         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a6ec4909fe577adf6f3973d3d7dbd36e2">setKey</a>(key);
<a name="l00320"></a>00320         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac35c23a4cfb14eed02b1d4350313b911">setValue</a>(value); <span class="comment">// for PointerKeyType, this is a little duplicating process</span>
<a name="l00321"></a>00321         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>;
<a name="l00322"></a>00322         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = y;
<a name="l00323"></a>00323         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00324"></a>00324         <span class="keywordflow">if</span> (hasRank) {
<a name="l00325"></a>00325             z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> = 1;
<a name="l00326"></a>00326         }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328         <span class="comment">// stitch it in</span>
<a name="l00329"></a>00329         <span class="keywordflow">if</span> (y == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00330"></a>00330             <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> = z;
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>(z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>(), y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>()) &lt; 0) {
<a name="l00333"></a>00333             y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = z;
<a name="l00334"></a>00334         }
<a name="l00335"></a>00335         <span class="keywordflow">else</span> {
<a name="l00336"></a>00336             y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = z;
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339         <span class="comment">// rotate tree to balance if needed</span>
<a name="l00340"></a>00340         <a class="code" href="classvoltdb_1_1CompactingMap.html#a89fadf0f0c9dac7b330bd9ba7193750d">insertFixup</a>(z);
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342     <span class="keywordflow">else</span> {
<a name="l00343"></a>00343         <span class="comment">// create a new node as root</span>
<a name="l00344"></a>00344         <span class="keywordtype">void</span> *memory = <a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#afcbcccaf9bf98d7fd78c6d7b05f89c10">alloc</a>();
<a name="l00345"></a>00345         assert(memory);
<a name="l00346"></a>00346         <span class="comment">// placement new</span>
<a name="l00347"></a>00347         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *z = <span class="keyword">new</span>(memory) <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>();
<a name="l00348"></a>00348         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a6ec4909fe577adf6f3973d3d7dbd36e2">setKey</a>(key);
<a name="l00349"></a>00349         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac35c23a4cfb14eed02b1d4350313b911">setValue</a>(value); <span class="comment">// for PointerKeyType, this is a little duplicating process</span>
<a name="l00350"></a>00350         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>;
<a name="l00351"></a>00351         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>;
<a name="l00352"></a>00352         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00353"></a>00353         <span class="keywordflow">if</span> (hasRank) {
<a name="l00354"></a>00354             z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> = 1;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356         <span class="comment">// make it root</span>
<a name="l00357"></a>00357         <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> = z;
<a name="l00358"></a>00358     }
<a name="l00359"></a>00359     <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>++;
<a name="l00360"></a>00360     assert(<a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#a0399b831d3d2f504b5a8349637f21834">count</a>() == <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>);
<a name="l00361"></a>00361     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00365"></a>00365 <span class="keyword">typename</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::iterator</a>
<a name="l00366"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a535ea3a93d6fe09cda5dbe2802f729bf">00366</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a535ea3a93d6fe09cda5dbe2802f729bf">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::lowerBound</a>(<span class="keyword">const</span> Key &amp;key)<span class="keyword"> const</span>
<a name="l00367"></a>00367 <span class="keyword"></span>{
<a name="l00368"></a>00368     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x = <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>;
<a name="l00369"></a>00369     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = <span class="keyword">const_cast&lt;</span><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>*<span class="keyword">&gt;</span>(&amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>);
<a name="l00370"></a>00370     <span class="keywordflow">while</span> (x != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00371"></a>00371         <span class="keywordtype">int</span> cmp = <a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>(), key);
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (cmp &lt; 0) {
<a name="l00373"></a>00373             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375         <span class="keywordflow">else</span> {
<a name="l00376"></a>00376             y = x;
<a name="l00377"></a>00377             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00378"></a>00378         }
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380     <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a>(<span class="keyword">this</span>, y);
<a name="l00381"></a>00381 }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00384"></a>00384 <span class="keyword">typename</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::iterator</a>
<a name="l00385"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#ab189d7e2235fb3d4f258d466025c11b0">00385</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#ab189d7e2235fb3d4f258d466025c11b0">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::upperBound</a>(<span class="keyword">const</span> Key &amp;key)<span class="keyword"> const</span>
<a name="l00386"></a>00386 <span class="keyword"></span>{
<a name="l00387"></a>00387     Key tmpKey(key);
<a name="l00388"></a>00388     <a class="code" href="namespacevoltdb.html#a876c55e558af5a641d092fa27fd846d9">setPointerValue</a>(tmpKey, <a class="code" href="CompactingMap_8h.html#a828aaca8426114ee5484d256eb3c1b7c">MAXPOINTER</a>);
<a name="l00389"></a>00389     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x = <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>;
<a name="l00390"></a>00390     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = <span class="keyword">const_cast&lt;</span><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>*<span class="keyword">&gt;</span>(&amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>);
<a name="l00391"></a>00391     <span class="keywordflow">while</span> (x != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00392"></a>00392         <span class="keywordtype">int</span> cmp = <a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>(), tmpKey);
<a name="l00393"></a>00393         <span class="keywordflow">if</span> (cmp &lt;= 0) {
<a name="l00394"></a>00394             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396         <span class="keywordflow">else</span> {
<a name="l00397"></a>00397             y = x;
<a name="l00398"></a>00398             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401     <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a>(<span class="keyword">this</span>, y);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00406"></a>00406 <span class="keyword">typename</span> std::pair&lt;typename CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::iterator,
<a name="l00407"></a>00407                    <span class="keyword">typename</span> <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::iterator</a>&gt;
<a name="l00408"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a2c45537d1a3f66a05f5a8dad4ef05f3e">00408</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a2c45537d1a3f66a05f5a8dad4ef05f3e">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::equalRange</a>(<span class="keyword">const</span> Key &amp;key)<span class="keyword"> const</span>
<a name="l00409"></a>00409 <span class="keyword"></span>{
<a name="l00410"></a>00410     <span class="keywordflow">return</span> std::pair&lt;iterator, iterator&gt;(<a class="code" href="classvoltdb_1_1CompactingMap.html#a535ea3a93d6fe09cda5dbe2802f729bf">lowerBound</a>(key), <a class="code" href="classvoltdb_1_1CompactingMap.html#ab189d7e2235fb3d4f258d466025c11b0">upperBound</a>(key));
<a name="l00411"></a>00411 }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00414"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a8095b21a83340fe57a97c27fbe305d5e">00414</a> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a419b1c69f062a714291763c282f42627">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::erase</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *z)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y, *x, *delnode = z;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="comment">// find a replacement node to swap with</span>
<a name="l00419"></a>00419     <span class="keywordflow">if</span> ((z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) || (z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>)) {
<a name="l00420"></a>00420         y = z;
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422     <span class="keywordflow">else</span> {
<a name="l00423"></a>00423         y = <a class="code" href="classvoltdb_1_1CompactingMap.html#a10e730998a390611e5f83ce33b64bbcc">successor</a>(z);
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426     <span class="keywordflow">if</span> (y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00427"></a>00427         x = y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429     <span class="keywordflow">else</span> {
<a name="l00430"></a>00430         x = y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="keywordflow">if</span> (y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00436"></a>00436         <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> = x;
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y == y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) {
<a name="l00439"></a>00439         y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = x;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     <span class="keywordflow">else</span> {
<a name="l00442"></a>00442         y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = x;
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445     <span class="keywordflow">if</span> (y != z) {
<a name="l00446"></a>00446         z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a> = y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>;
<a name="l00447"></a>00447         delnode = y;
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (hasRank) {
<a name="l00450"></a>00450         <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *ct = delnode;
<a name="l00451"></a>00451         <span class="keywordflow">while</span> (ct != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00452"></a>00452             ct = ct-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00453"></a>00453             <a class="code" href="classvoltdb_1_1CompactingMap.html#a29e437ee65024d104bd05b5bb61e5abd">decSubct</a>(ct);
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     <span class="keywordflow">if</span> (y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>) {
<a name="l00458"></a>00458         <a class="code" href="classvoltdb_1_1CompactingMap.html#a5c93710d259f1272936d4ca3f34906a1">deleteFixup</a>(x);
<a name="l00459"></a>00459     }
<a name="l00460"></a>00460     <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>--;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="comment">// move a node to fill this hole</span>
<a name="l00463"></a>00463     <a class="code" href="classvoltdb_1_1CompactingMap.html#a999fc66444d2524385c94335a4b114d6">fragmentFixup</a>(delnode);
<a name="l00464"></a>00464 }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00467"></a>00467 <span class="keyword">typename</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::TreeNode</a> *
<a name="l00468"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a85737c90e336d640a1af52d5c8e9f1e9">00468</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a85737c90e336d640a1af52d5c8e9f1e9">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::lookup</a>(<span class="keyword">const</span> Key &amp;key)<span class="keyword"> const</span>
<a name="l00469"></a>00469 <span class="keyword"></span>{
<a name="l00470"></a>00470     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x = <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>;
<a name="l00471"></a>00471     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *retval = <span class="keyword">const_cast&lt;</span><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>*<span class="keyword">&gt;</span>(&amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>);
<a name="l00472"></a>00472     <span class="keywordflow">while</span> (x != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00473"></a>00473         <span class="keywordtype">int</span> cmp = <a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>(), key);
<a name="l00474"></a>00474         <span class="keywordflow">if</span> (cmp &lt; 0) {
<a name="l00475"></a>00475             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00476"></a>00476         }
<a name="l00477"></a>00477         <span class="keywordflow">else</span> {
<a name="l00478"></a>00478             <span class="keywordflow">if</span> (cmp == 0) {
<a name="l00479"></a>00479                 <span class="comment">//TODO: optimize for the (usual) unique index case, where</span>
<a name="l00480"></a>00480                 <span class="comment">// the first match found is known to be the only one:</span>
<a name="l00481"></a>00481                 <span class="comment">// if (m_unique) {</span>
<a name="l00482"></a>00482                 <span class="comment">//     return x;</span>
<a name="l00483"></a>00483                 <span class="comment">// }</span>
<a name="l00484"></a>00484                 retval = x;
<a name="l00485"></a>00485             }
<a name="l00486"></a>00486             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488     }
<a name="l00489"></a>00489     <span class="keywordflow">return</span> retval;
<a name="l00490"></a>00490 }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00493"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a53db1ecaa3ad20fc7c7042aef675fc46">00493</a> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a53db1ecaa3ad20fc7c7042aef675fc46">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::leftRotate</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x)
<a name="l00494"></a>00494 {
<a name="l00495"></a>00495     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00498"></a>00498     <span class="keywordflow">if</span> (y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00499"></a>00499         y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = x;
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501     y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00502"></a>00502     <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00503"></a>00503         <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> = y;
<a name="l00504"></a>00504     }
<a name="l00505"></a>00505     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x == x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) {
<a name="l00506"></a>00506         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = y;
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     <span class="keywordflow">else</span> {
<a name="l00509"></a>00509         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = y;
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511     y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = x;
<a name="l00512"></a>00512     x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = y;
<a name="l00513"></a>00513 
<a name="l00514"></a>00514     <span class="keywordflow">if</span> (hasRank) {
<a name="l00515"></a>00515         <a class="code" href="classvoltdb_1_1CompactingMap.html#acd9df75422f296b0427720969a70392b">updateSubct</a>(x);
<a name="l00516"></a>00516         <a class="code" href="classvoltdb_1_1CompactingMap.html#acd9df75422f296b0427720969a70392b">updateSubct</a>(y);
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00521"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a82b170ebd6349e0456b696d573fc27de">00521</a> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a82b170ebd6349e0456b696d573fc27de">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::rightRotate</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x)
<a name="l00522"></a>00522 {
<a name="l00523"></a>00523     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525     x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00526"></a>00526     <span class="keywordflow">if</span> (y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00527"></a>00527         y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = x;
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529     y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00531"></a>00531         <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> = y;
<a name="l00532"></a>00532     }
<a name="l00533"></a>00533     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x == x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>) {
<a name="l00534"></a>00534         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = y;
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536     <span class="keywordflow">else</span> {
<a name="l00537"></a>00537         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = y;
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539     y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = x;
<a name="l00540"></a>00540     x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = y;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (hasRank) {
<a name="l00543"></a>00543         <a class="code" href="classvoltdb_1_1CompactingMap.html#acd9df75422f296b0427720969a70392b">updateSubct</a>(x);
<a name="l00544"></a>00544         <a class="code" href="classvoltdb_1_1CompactingMap.html#acd9df75422f296b0427720969a70392b">updateSubct</a>(y);
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546 }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00549"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a89fadf0f0c9dac7b330bd9ba7193750d">00549</a> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a89fadf0f0c9dac7b330bd9ba7193750d">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::insertFixup</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *z)
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551     <span class="keywordflow">while</span> (z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>) {
<a name="l00552"></a>00552         <span class="keywordflow">if</span> (z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> == z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) {
<a name="l00553"></a>00553             <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00554"></a>00554             <span class="keywordflow">if</span> (y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>) {
<a name="l00555"></a>00555                 z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00556"></a>00556                 y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00557"></a>00557                 z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00558"></a>00558                 z = z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00559"></a>00559             }
<a name="l00560"></a>00560             <span class="keywordflow">else</span> {
<a name="l00561"></a>00561                 <span class="keywordflow">if</span> (z == z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>) {
<a name="l00562"></a>00562                     z = z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00563"></a>00563                     <a class="code" href="classvoltdb_1_1CompactingMap.html#a53db1ecaa3ad20fc7c7042aef675fc46">leftRotate</a>(z);
<a name="l00564"></a>00564                 }
<a name="l00565"></a>00565                 z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00566"></a>00566                 z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00567"></a>00567                 <a class="code" href="classvoltdb_1_1CompactingMap.html#a82b170ebd6349e0456b696d573fc27de">rightRotate</a>(z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>);
<a name="l00568"></a>00568             }
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570         <span class="keywordflow">else</span> {
<a name="l00571"></a>00571             <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00572"></a>00572             <span class="keywordflow">if</span> (y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>) {
<a name="l00573"></a>00573                 z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00574"></a>00574                 y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00575"></a>00575                 z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00576"></a>00576                 z = z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00577"></a>00577             }
<a name="l00578"></a>00578             <span class="keywordflow">else</span> {
<a name="l00579"></a>00579                 <span class="keywordflow">if</span> (z == z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) {
<a name="l00580"></a>00580                     z = z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00581"></a>00581                     <a class="code" href="classvoltdb_1_1CompactingMap.html#a82b170ebd6349e0456b696d573fc27de">rightRotate</a>(z);
<a name="l00582"></a>00582                 }
<a name="l00583"></a>00583                 z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00584"></a>00584                 z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00585"></a>00585                 <a class="code" href="classvoltdb_1_1CompactingMap.html#a53db1ecaa3ad20fc7c7042aef675fc46">leftRotate</a>(z-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>);
<a name="l00586"></a>00586             }
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     <span class="comment">// added this myself</span>
<a name="l00591"></a>00591     <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00592"></a>00592 }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00595"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a5c93710d259f1272936d4ca3f34906a1">00595</a> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a5c93710d259f1272936d4ca3f34906a1">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::deleteFixup</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x)
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597     <span class="keywordflow">while</span> ((x != <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>) &amp;&amp; (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>)) {
<a name="l00598"></a>00598         <span class="keywordflow">if</span> (x == x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) {
<a name="l00599"></a>00599             <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *w = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00600"></a>00600             <span class="keywordflow">if</span> (w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>) {
<a name="l00601"></a>00601                 w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00602"></a>00602                 x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00603"></a>00603                 <a class="code" href="classvoltdb_1_1CompactingMap.html#a53db1ecaa3ad20fc7c7042aef675fc46">leftRotate</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>);
<a name="l00604"></a>00604                 w = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00605"></a>00605             }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607             <span class="keywordflow">if</span> ((w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>) &amp;&amp; (w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>)) {
<a name="l00608"></a>00608                 w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00609"></a>00609                 x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00610"></a>00610             }
<a name="l00611"></a>00611             <span class="keywordflow">else</span> {
<a name="l00612"></a>00612                 <span class="keywordflow">if</span> (w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>) {
<a name="l00613"></a>00613                     w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00614"></a>00614                     w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00615"></a>00615                     <a class="code" href="classvoltdb_1_1CompactingMap.html#a82b170ebd6349e0456b696d573fc27de">rightRotate</a>(w);
<a name="l00616"></a>00616                     w = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00617"></a>00617                 }
<a name="l00618"></a>00618                 w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a>;
<a name="l00619"></a>00619                 x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00620"></a>00620                 w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00621"></a>00621                 <a class="code" href="classvoltdb_1_1CompactingMap.html#a53db1ecaa3ad20fc7c7042aef675fc46">leftRotate</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>);
<a name="l00622"></a>00622                 x = <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>;
<a name="l00623"></a>00623             }
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625         <span class="keywordflow">else</span> {
<a name="l00626"></a>00626             <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *w = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00627"></a>00627             <span class="keywordflow">if</span> (w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>) {
<a name="l00628"></a>00628                 w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00629"></a>00629                 x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00630"></a>00630                 <a class="code" href="classvoltdb_1_1CompactingMap.html#a82b170ebd6349e0456b696d573fc27de">rightRotate</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>);
<a name="l00631"></a>00631                 w = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00632"></a>00632             }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634             <span class="keywordflow">if</span> ((w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>) &amp;&amp; (w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>)) {
<a name="l00635"></a>00635                 w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00636"></a>00636                 x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00637"></a>00637             }
<a name="l00638"></a>00638             <span class="keywordflow">else</span> {
<a name="l00639"></a>00639                 <span class="keywordflow">if</span> (w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>) {
<a name="l00640"></a>00640                     w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00641"></a>00641                     w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>;
<a name="l00642"></a>00642                     <a class="code" href="classvoltdb_1_1CompactingMap.html#a53db1ecaa3ad20fc7c7042aef675fc46">leftRotate</a>(w);
<a name="l00643"></a>00643                     w = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00644"></a>00644                 }
<a name="l00645"></a>00645                 w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a>;
<a name="l00646"></a>00646                 x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00647"></a>00647                 w-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00648"></a>00648                 <a class="code" href="classvoltdb_1_1CompactingMap.html#a82b170ebd6349e0456b696d573fc27de">rightRotate</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>);
<a name="l00649"></a>00649                 x = <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>;
<a name="l00650"></a>00650             }
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652     }
<a name="l00653"></a>00653     x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>;
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00657"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a999fc66444d2524385c94335a4b114d6">00657</a> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a999fc66444d2524385c94335a4b114d6">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::fragmentFixup</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *X) {
<a name="l00658"></a>00658     <span class="comment">// tree is empty now (after the recent delete)</span>
<a name="l00659"></a>00659     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a> == 0) {
<a name="l00660"></a>00660         X-&gt;~TreeNode();
<a name="l00661"></a>00661         <a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#aae80e176e7f1cbc120be93d5aa3d298b">trim</a>();
<a name="l00662"></a>00662         assert(<a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#a0399b831d3d2f504b5a8349637f21834">count</a>() == <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>);
<a name="l00663"></a>00663         <span class="keywordflow">return</span>;
<a name="l00664"></a>00664     }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     <span class="comment">// last item allocated in our contiguous memory</span>
<a name="l00667"></a>00667     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *last = <span class="keyword">static_cast&lt;</span><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>*<span class="keyword">&gt;</span>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#ae237482943f5ae8ad83737851253ad66">last</a>());
<a name="l00668"></a>00668 
<a name="l00669"></a>00669     <span class="comment">// if deleting the last item</span>
<a name="l00670"></a>00670     <span class="keywordflow">if</span> (last == X) {
<a name="l00671"></a>00671         X-&gt;~TreeNode();
<a name="l00672"></a>00672         <a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#aae80e176e7f1cbc120be93d5aa3d298b">trim</a>();
<a name="l00673"></a>00673         assert(<a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#a0399b831d3d2f504b5a8349637f21834">count</a>() == <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>);
<a name="l00674"></a>00674         <span class="keywordflow">return</span>;
<a name="l00675"></a>00675     }
<a name="l00676"></a>00676 
<a name="l00677"></a>00677     <span class="comment">// last should be a real node</span>
<a name="l00678"></a>00678     <span class="comment">//assert(isReachableNode(m_root, last));</span>
<a name="l00679"></a>00679 
<a name="l00680"></a>00680     <span class="comment">// if there&apos;s a parent node, make it point to the hole</span>
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00682"></a>00682         <span class="comment">//assert(isReachableNode(m_root, last-&gt;parent));</span>
<a name="l00683"></a>00683 
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> == last) {
<a name="l00685"></a>00685             last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = X;
<a name="l00686"></a>00686         }
<a name="l00687"></a>00687         <span class="keywordflow">else</span> {
<a name="l00688"></a>00688             assert(last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> == last);
<a name="l00689"></a>00689             last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = X;
<a name="l00690"></a>00690         }
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693     <span class="comment">// if there&apos;s children, make their parents point to hole</span>
<a name="l00694"></a>00694     <span class="keywordflow">if</span> (last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00695"></a>00695         last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = X;
<a name="l00696"></a>00696     }
<a name="l00697"></a>00697     <span class="keywordflow">if</span> (last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00698"></a>00698         last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = X;
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     <span class="comment">// copy the last node over the deleted node</span>
<a name="l00702"></a>00702     assert(X != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>);
<a name="l00703"></a>00703     X-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> = last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00704"></a>00704     X-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> = last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00705"></a>00705     X-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> = last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00706"></a>00706     X-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> = last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a>;
<a name="l00707"></a>00707     X-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a> = last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>;
<a name="l00708"></a>00708     <span class="keywordflow">if</span> (hasRank) {
<a name="l00709"></a>00709         X-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> = last-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a>;
<a name="l00710"></a>00710     }
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="comment">// fix the root pointer if needed</span>
<a name="l00713"></a>00713     <span class="keywordflow">if</span> (last == <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>) {
<a name="l00714"></a>00714         <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> = X;
<a name="l00715"></a>00715     }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     last-&gt;~TreeNode();
<a name="l00718"></a>00718     <a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#aae80e176e7f1cbc120be93d5aa3d298b">trim</a>();
<a name="l00719"></a>00719     assert(<a class="code" href="classvoltdb_1_1CompactingMap.html#aba809aab34ed216ae2434abb37328392">m_allocator</a>.<a class="code" href="classvoltdb_1_1ContiguousAllocator.html#a0399b831d3d2f504b5a8349637f21834">count</a>() == <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>);
<a name="l00720"></a>00720 }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00723"></a>00723 <span class="keyword">typename</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::TreeNode</a>*
<a name="l00724"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a384b656093b2844c6ec805c18fb05ade">00724</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a384b656093b2844c6ec805c18fb05ade">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::minimum</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *subRoot)<span class="keyword"> const</span>
<a name="l00725"></a>00725 <span class="keyword"></span>{
<a name="l00726"></a>00726     <span class="keywordflow">while</span> (subRoot-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00727"></a>00727         subRoot = subRoot-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729     <span class="keywordflow">return</span> <span class="keyword">const_cast&lt;</span><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>*<span class="keyword">&gt;</span>(subRoot);
<a name="l00730"></a>00730 }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00733"></a>00733 <span class="keyword">typename</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::TreeNode</a>*
<a name="l00734"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a72dcd8315ad6c09cb34a892962eec3da">00734</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a72dcd8315ad6c09cb34a892962eec3da">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::maximum</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *subRoot)<span class="keyword"> const</span>
<a name="l00735"></a>00735 <span class="keyword"></span>{
<a name="l00736"></a>00736     <span class="keywordflow">while</span> (subRoot-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00737"></a>00737         subRoot = subRoot-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739     <span class="keywordflow">return</span> <span class="keyword">const_cast&lt;</span><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>*<span class="keyword">&gt;</span>(subRoot);
<a name="l00740"></a>00740 }
<a name="l00741"></a>00741 
<a name="l00742"></a>00742 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00743"></a>00743 <span class="keyword">typename</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::TreeNode</a>*
<a name="l00744"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a10e730998a390611e5f83ce33b64bbcc">00744</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a10e730998a390611e5f83ce33b64bbcc">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::successor</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x)<span class="keyword"> const</span>
<a name="l00745"></a>00745 <span class="keyword"></span>{
<a name="l00746"></a>00746     <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00747"></a>00747         <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a384b656093b2844c6ec805c18fb05ade">minimum</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>);
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00750"></a>00750     <span class="keywordflow">while</span> ((y != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (x == y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>)) {
<a name="l00751"></a>00751         x = y;
<a name="l00752"></a>00752         y = y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754     <span class="keywordflow">return</span> y;
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00758"></a>00758 <span class="keyword">typename</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::TreeNode</a>*
<a name="l00759"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a737a70666b78216bff6531b76d43a1d4">00759</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a737a70666b78216bff6531b76d43a1d4">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::predecessor</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x)<span class="keyword"> const</span>
<a name="l00760"></a>00760 <span class="keyword"></span>{
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00762"></a>00762         <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a72dcd8315ad6c09cb34a892962eec3da">maximum</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>);
<a name="l00763"></a>00763     }
<a name="l00764"></a>00764     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *y = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00765"></a>00765     <span class="keywordflow">while</span> ((y != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (x == y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>)) {
<a name="l00766"></a>00766         x = y;
<a name="l00767"></a>00767         y = y-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00768"></a>00768     }
<a name="l00769"></a>00769     <span class="keywordflow">return</span> y;
<a name="l00770"></a>00770 }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00773"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a857c3319d8d0d7622b6df27e19ee181e">00773</a> <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a857c3319d8d0d7622b6df27e19ee181e">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::isReachableNode</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>* start, <span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *dest)<span class="keyword"> const</span>
<a name="l00774"></a>00774 <span class="keyword"></span>{
<a name="l00775"></a>00775     <span class="keywordflow">if</span> (start == dest) {
<a name="l00776"></a>00776         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778     <span class="keywordflow">if</span> ((start-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) &amp;&amp; (<a class="code" href="classvoltdb_1_1CompactingMap.html#a857c3319d8d0d7622b6df27e19ee181e">isReachableNode</a>(start-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>, dest))) {
<a name="l00779"></a>00779         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00780"></a>00780     }
<a name="l00781"></a>00781     <span class="keywordflow">if</span> ((start-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>) &amp;&amp; (<a class="code" href="classvoltdb_1_1CompactingMap.html#a857c3319d8d0d7622b6df27e19ee181e">isReachableNode</a>(start-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>, dest))) {
<a name="l00782"></a>00782         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00783"></a>00783     }
<a name="l00784"></a>00784     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00788"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">00788</a> <span class="keyword">inline</span> int64_t <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::getSubct</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>* x)<span class="keyword"> const</span>
<a name="l00789"></a>00789 <span class="keyword"></span>{
<a name="l00790"></a>00790     <span class="keywordflow">if</span> (x == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00791"></a>00791         <span class="keywordflow">return</span> 0;
<a name="l00792"></a>00792     }
<a name="l00793"></a>00793 
<a name="l00794"></a>00794     <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> == <a class="code" href="CompactingMap_8h.html#a5fb2075a127575b77776ed5139fa6cc1">INVALIDCT</a>) {
<a name="l00795"></a>00795         <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) + <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>) + 1;
<a name="l00796"></a>00796     }
<a name="l00797"></a>00797     <span class="comment">// return 32_t, cast it to 64_t automatically</span>
<a name="l00798"></a>00798     <span class="keywordflow">return</span> x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a>;
<a name="l00799"></a>00799 }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00802"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#acd81c7053dea04eac6a8597ccce9af93">00802</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#acd81c7053dea04eac6a8597ccce9af93">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::incSubct</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>* x) {
<a name="l00803"></a>00803     <span class="keywordflow">if</span> (x == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00804"></a>00804         <span class="keywordflow">return</span>;
<a name="l00805"></a>00805     }
<a name="l00806"></a>00806     <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> == <a class="code" href="CompactingMap_8h.html#a5fb2075a127575b77776ed5139fa6cc1">INVALIDCT</a>) {
<a name="l00807"></a>00807         <span class="keywordflow">return</span>;
<a name="l00808"></a>00808     }
<a name="l00809"></a>00809     <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> == <a class="code" href="CompactingMap_8h.html#af2971340ad4ae40c4793a3f1429e3bec">SUBCTMAX</a>) {
<a name="l00810"></a>00810         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> = <a class="code" href="CompactingMap_8h.html#a5fb2075a127575b77776ed5139fa6cc1">INVALIDCT</a>;
<a name="l00811"></a>00811     }
<a name="l00812"></a>00812     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> &lt; <a class="code" href="CompactingMap_8h.html#af2971340ad4ae40c4793a3f1429e3bec">SUBCTMAX</a>) {
<a name="l00813"></a>00813         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a>++;
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815 }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00818"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a29e437ee65024d104bd05b5bb61e5abd">00818</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a29e437ee65024d104bd05b5bb61e5abd">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::decSubct</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>* x)
<a name="l00819"></a>00819 {
<a name="l00820"></a>00820     <span class="keywordflow">if</span> (x == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00821"></a>00821         <span class="keywordflow">return</span>;
<a name="l00822"></a>00822     }
<a name="l00823"></a>00823     <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> == <a class="code" href="CompactingMap_8h.html#a5fb2075a127575b77776ed5139fa6cc1">INVALIDCT</a>) {
<a name="l00824"></a>00824         <a class="code" href="classvoltdb_1_1CompactingMap.html#acd9df75422f296b0427720969a70392b">updateSubct</a>(x);
<a name="l00825"></a>00825     } <span class="keywordflow">else</span> {
<a name="l00826"></a>00826         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a>--;
<a name="l00827"></a>00827     }
<a name="l00828"></a>00828 }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00831"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#acd9df75422f296b0427720969a70392b">00831</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#acd9df75422f296b0427720969a70392b">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::updateSubct</a>(<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>* x)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833     <span class="keywordflow">if</span> (x == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00834"></a>00834         <span class="keywordflow">return</span>;
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     int64_t sumct = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) + <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>) + 1;
<a name="l00838"></a>00838     <span class="keywordflow">if</span> (sumct &lt;= <a class="code" href="CompactingMap_8h.html#af2971340ad4ae40c4793a3f1429e3bec">SUBCTMAX</a>) {
<a name="l00839"></a>00839         <span class="comment">// assign the lower 32 value to subct</span>
<a name="l00840"></a>00840         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> = <span class="keyword">static_cast&lt;</span><a class="code" href="CompactingMap_8h.html#ac21bb2d05c29ed1bdd0df2d7d0c43954">NodeCount</a><span class="keyword">&gt;</span>(sumct);
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842     <span class="keywordflow">else</span> {
<a name="l00843"></a>00843         x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8e74ac1333dc14758e0dc722cd848efc">subct</a> = <a class="code" href="CompactingMap_8h.html#a5fb2075a127575b77776ed5139fa6cc1">INVALIDCT</a>;
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845 }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00848"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#ae1cf32db2c633effc23a95cb3d107b9d">00848</a> int64_t <a class="code" href="classvoltdb_1_1CompactingMap.html#ae1cf32db2c633effc23a95cb3d107b9d">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::rankAsc</a>(<span class="keyword">const</span> Key&amp; key)<span class="keyword"> const</span>
<a name="l00849"></a>00849 <span class="keyword"></span>{
<a name="l00850"></a>00850     <span class="keywordflow">if</span> (!hasRank) {
<a name="l00851"></a>00851         <span class="keywordflow">return</span> -1;
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *n = <a class="code" href="classvoltdb_1_1CompactingMap.html#a85737c90e336d640a1af52d5c8e9f1e9">lookup</a>(key);
<a name="l00854"></a>00854     <span class="comment">// return -1 if the key passed in is not in the map</span>
<a name="l00855"></a>00855     <span class="keywordflow">if</span> (n == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00856"></a>00856         <span class="keywordflow">return</span> -1;
<a name="l00857"></a>00857     }
<a name="l00858"></a>00858     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *p = n;
<a name="l00859"></a>00859     int64_t ct = 0,ctr = 0, ctl = 0;
<a name="l00860"></a>00860     <span class="comment">// only compare the &quot;data&quot; part of the key</span>
<a name="l00861"></a>00861     <span class="keywordtype">int</span> m = <a class="code" href="classvoltdb_1_1CompactingMap.html#a83aec764bd6dceb39a371df6c882aa33">compareKeyRegardlessOfPointer</a>(key, <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>);
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (m == 0) {
<a name="l00863"></a>00863         <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00864"></a>00864             ctr = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>);
<a name="l00865"></a>00865         }
<a name="l00866"></a>00866         ct = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>) - ctr;
<a name="l00867"></a>00867         <span class="keywordflow">while</span>(p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00868"></a>00868             <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a83aec764bd6dceb39a371df6c882aa33">compareKeyRegardlessOfPointer</a>(key, p) == 0) {
<a name="l00869"></a>00869                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00870"></a>00870                     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a83aec764bd6dceb39a371df6c882aa33">compareKeyRegardlessOfPointer</a>(key, p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>) == 0) {
<a name="l00871"></a>00871                         ct-= <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>);
<a name="l00872"></a>00872                     }
<a name="l00873"></a>00873                 }
<a name="l00874"></a>00874                 ct--;
<a name="l00875"></a>00875             }
<a name="l00876"></a>00876             p = p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00877"></a>00877         }
<a name="l00878"></a>00878     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m &gt; 0) {
<a name="l00879"></a>00879         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00880"></a>00880             ctr = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>);
<a name="l00881"></a>00881         }
<a name="l00882"></a>00882         ct = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p) - ctr;
<a name="l00883"></a>00883         <span class="keywordflow">while</span> (p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00884"></a>00884             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> == p) {
<a name="l00885"></a>00885                 ct += <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>) - <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p);
<a name="l00886"></a>00886             }
<a name="l00887"></a>00887             p = p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00888"></a>00888         }
<a name="l00889"></a>00889     } <span class="keywordflow">else</span> {
<a name="l00890"></a>00890         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00891"></a>00891             ctl = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>);
<a name="l00892"></a>00892         }
<a name="l00893"></a>00893         ct = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p) - ctl - 1;
<a name="l00894"></a>00894         <span class="keywordflow">while</span> (p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00895"></a>00895             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> == p) {
<a name="l00896"></a>00896                 ct += <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>) - <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(p);
<a name="l00897"></a>00897             }
<a name="l00898"></a>00898             p = p-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a>;
<a name="l00899"></a>00899         }
<a name="l00900"></a>00900         ct = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>) - ct;
<a name="l00901"></a>00901     }
<a name="l00902"></a>00902     <span class="keywordflow">return</span> ct;
<a name="l00903"></a>00903 }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00906"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a796583934a55cd62e6a238bf9299e253">00906</a> int64_t <a class="code" href="classvoltdb_1_1CompactingMap.html#a796583934a55cd62e6a238bf9299e253">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::rankUpper</a>(<span class="keyword">const</span> Key&amp; key)<span class="keyword"> const</span>
<a name="l00907"></a>00907 <span class="keyword"></span>{
<a name="l00908"></a>00908     <span class="keywordflow">if</span> (!hasRank) {
<a name="l00909"></a>00909         <span class="keywordflow">return</span> -1;
<a name="l00910"></a>00910     }
<a name="l00911"></a>00911     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#ac2e95d8474d0825541a41e3ab7a3d519">m_unique</a>) {
<a name="l00912"></a>00912         <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ae1cf32db2c633effc23a95cb3d107b9d">rankAsc</a>(key);
<a name="l00913"></a>00913     }
<a name="l00914"></a>00914     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *n = <a class="code" href="classvoltdb_1_1CompactingMap.html#a85737c90e336d640a1af52d5c8e9f1e9">lookup</a>(key);
<a name="l00915"></a>00915     <span class="comment">// return -1 if the key passed in is not in the map</span>
<a name="l00916"></a>00916     <span class="keywordflow">if</span> (n == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00917"></a>00917         <span class="keywordflow">return</span> -1;
<a name="l00918"></a>00918     }
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a> it;
<a name="l00921"></a>00921     it = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab189d7e2235fb3d4f258d466025c11b0">upperBound</a>(key);
<a name="l00922"></a>00922     <span class="keywordflow">if</span> (it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a2d7048d74e611858068ebc76d6dba7e2">isEnd</a>()) {
<a name="l00923"></a>00923         <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>;
<a name="l00924"></a>00924     }
<a name="l00925"></a>00925     <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ae1cf32db2c633effc23a95cb3d107b9d">rankAsc</a>(it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a969041c693fff058421f5d700442e631">key</a>()) - 1;
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00929"></a>00929 <span class="keyword">typename</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::TreeNode</a>*
<a name="l00930"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a70781434c7629604c4da1a89932db1dd">00930</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a70781434c7629604c4da1a89932db1dd">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::lookupRank</a>(int64_t ith)<span class="keyword"> const</span>
<a name="l00931"></a>00931 <span class="keyword"></span>{
<a name="l00932"></a>00932     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *retval = <span class="keyword">const_cast&lt;</span><a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a>*<span class="keyword">&gt;</span>(&amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>);
<a name="l00933"></a>00933     <span class="keywordflow">if</span> ((!hasRank) || <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a> || ith &gt; <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>)) {
<a name="l00934"></a>00934         <span class="keywordflow">return</span> retval;
<a name="l00935"></a>00935     }
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *x = <a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>;
<a name="l00938"></a>00938     int64_t rk = ith;
<a name="l00939"></a>00939     int64_t xl = 0;
<a name="l00940"></a>00940     <span class="keywordflow">while</span> (x != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a> &amp;&amp; rk &gt; 0) {
<a name="l00941"></a>00941         <span class="keywordflow">if</span> (x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00942"></a>00942             xl = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>);
<a name="l00943"></a>00943         }
<a name="l00944"></a>00944         <span class="keywordflow">if</span> (rk == xl + 1) {
<a name="l00945"></a>00945             retval = x;
<a name="l00946"></a>00946             rk = 0;
<a name="l00947"></a>00947         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rk &lt; xl + 1) {
<a name="l00948"></a>00948             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>;
<a name="l00949"></a>00949         } <span class="keywordflow">else</span> {
<a name="l00950"></a>00950             x = x-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>;
<a name="l00951"></a>00951             rk -= (xl + 1);
<a name="l00952"></a>00952         }
<a name="l00953"></a>00953         xl = 0;
<a name="l00954"></a>00954     }
<a name="l00955"></a>00955     <span class="keywordflow">return</span> retval;
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l00959"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a9d70dd20475e0a5b8bc3f786dd270da7">00959</a> <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a9d70dd20475e0a5b8bc3f786dd270da7">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::verifyRank</a>()<span class="keyword"> const</span>
<a name="l00960"></a>00960 <span class="keyword"></span>{
<a name="l00961"></a>00961     <span class="keywordflow">if</span> (!hasRank) {
<a name="l00962"></a>00962         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00963"></a>00963     }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965     <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a> it;
<a name="l00966"></a>00966     int64_t rkasc;
<a name="l00967"></a>00967     <span class="comment">// iterate rank start from 1 to m_count</span>
<a name="l00968"></a>00968     <span class="keywordflow">for</span> (int64_t i = 1; i &lt;= <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>; i++) {
<a name="l00969"></a>00969         it = <a class="code" href="classvoltdb_1_1CompactingMap.html#aecab6a57563265f484e0840da60ffde8">findRank</a>(i);
<a name="l00970"></a>00970         <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a85737c90e336d640a1af52d5c8e9f1e9">lookup</a>(it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a969041c693fff058421f5d700442e631">key</a>()) == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l00971"></a>00971             printf(<span class="stringliteral">&quot;Can not find rank %ld node with key\n&quot;</span>, (<span class="keywordtype">long</span>)i);
<a name="l00972"></a>00972             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00973"></a>00973         }
<a name="l00974"></a>00974 
<a name="l00975"></a>00975         <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#ac2e95d8474d0825541a41e3ab7a3d519">m_unique</a>) {
<a name="l00976"></a>00976             <span class="keywordflow">if</span> ((rkasc = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae1cf32db2c633effc23a95cb3d107b9d">rankAsc</a>(it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a969041c693fff058421f5d700442e631">key</a>())) != i) {
<a name="l00977"></a>00977                 printf(<span class="stringliteral">&quot;false: unique_rankAsc expected %ld, but got %ld\n&quot;</span>, (<span class="keywordtype">long</span>)i, (<span class="keywordtype">long</span>)rkasc);
<a name="l00978"></a>00978                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00979"></a>00979             }
<a name="l00980"></a>00980         } <span class="keywordflow">else</span> {
<a name="l00981"></a>00981             <span class="keyword">const</span> Key k = it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a969041c693fff058421f5d700442e631">key</a>();
<a name="l00982"></a>00982             <span class="comment">// test rankUpper</span>
<a name="l00983"></a>00983             <a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html">iterator</a> up = <a class="code" href="classvoltdb_1_1CompactingMap.html#ab189d7e2235fb3d4f258d466025c11b0">upperBound</a>(k);
<a name="l00984"></a>00984             int64_t rkUpper;
<a name="l00985"></a>00985             <span class="keywordflow">if</span> (up.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a2d7048d74e611858068ebc76d6dba7e2">isEnd</a>()) {
<a name="l00986"></a>00986                 <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a> == i) {
<a name="l00987"></a>00987                     rkUpper = <a class="code" href="classvoltdb_1_1CompactingMap.html#a796583934a55cd62e6a238bf9299e253">rankUpper</a>(k);
<a name="l00988"></a>00988                     <span class="keywordflow">if</span> (rkUpper != <a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>) {
<a name="l00989"></a>00989                         printf(<span class="stringliteral">&quot;false: multi_rankUpper expected %ld, but got %ld\n&quot;</span>, (<span class="keywordtype">long</span>)i, (<span class="keywordtype">long</span>)rkUpper);
<a name="l00990"></a>00990                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00991"></a>00991                     }
<a name="l00992"></a>00992                 }
<a name="l00993"></a>00993             } <span class="keywordflow">else</span> {
<a name="l00994"></a>00994                 up.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac59e4a1b7a76d507947c87c85b87c77a">movePrev</a>();
<a name="l00995"></a>00995                 <span class="keywordflow">if</span> (it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#afb66c0e169ba9a1f5921268c3fe20728">equals</a>(up)) {
<a name="l00996"></a>00996                     rkUpper = <a class="code" href="classvoltdb_1_1CompactingMap.html#a796583934a55cd62e6a238bf9299e253">rankUpper</a>(k);
<a name="l00997"></a>00997                     <span class="keywordflow">if</span> (rkUpper != i) {
<a name="l00998"></a>00998                         printf(<span class="stringliteral">&quot;false: multi_rankUpper expected %ld, but got %ld\n&quot;</span>, (<span class="keywordtype">long</span>)i, (<span class="keywordtype">long</span>)rkUpper);
<a name="l00999"></a>00999                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01000"></a>01000                     }
<a name="l01001"></a>01001                 }
<a name="l01002"></a>01002             }
<a name="l01003"></a>01003             <span class="comment">// test rankAsc</span>
<a name="l01004"></a>01004             rkasc = <a class="code" href="classvoltdb_1_1CompactingMap.html#ae1cf32db2c633effc23a95cb3d107b9d">rankAsc</a>(k);
<a name="l01005"></a>01005             int64_t nc = 0;
<a name="l01006"></a>01006             it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac59e4a1b7a76d507947c87c85b87c77a">movePrev</a>();
<a name="l01007"></a>01007             <span class="keywordflow">while</span> (k == it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#a969041c693fff058421f5d700442e631">key</a>()) {
<a name="l01008"></a>01008                 nc++;
<a name="l01009"></a>01009                 it.<a class="code" href="classvoltdb_1_1CompactingMap_1_1iterator.html#ac59e4a1b7a76d507947c87c85b87c77a">movePrev</a>();
<a name="l01010"></a>01010             }
<a name="l01011"></a>01011             <span class="keywordflow">if</span> (rkasc + nc != i) {
<a name="l01012"></a>01012                 printf(<span class="stringliteral">&quot;false: multi_rankAsc %ld keys are the same&quot;</span>, (<span class="keywordtype">long</span>)nc);
<a name="l01013"></a>01013                 printf(<span class="stringliteral">&quot;false: multi_rankAsc expected %ld, but got %ld\n&quot;</span>, (<span class="keywordtype">long</span>)i, (<span class="keywordtype">long</span>)rkasc);
<a name="l01014"></a>01014                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01015"></a>01015             }
<a name="l01016"></a>01016         }
<a name="l01017"></a>01017     }
<a name="l01018"></a>01018     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01019"></a>01019 }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l01022"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#ad64f17e1e919aa57f8fcd255a3d25ec5">01022</a> <span class="keywordtype">bool</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ad64f17e1e919aa57f8fcd255a3d25ec5">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::verify</a>()<span class="keyword"> const</span>
<a name="l01023"></a>01023 <span class="keyword"></span>{
<a name="l01024"></a>01024     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>.<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> != <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>) {
<a name="l01025"></a>01025         printf(<span class="stringliteral">&quot;NIL is red\n&quot;</span>);
<a name="l01026"></a>01026         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01027"></a>01027     }
<a name="l01028"></a>01028     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>.<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l01029"></a>01029         printf(<span class="stringliteral">&quot;NIL left is not NIL\n&quot;</span>);
<a name="l01030"></a>01030         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>.<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l01033"></a>01033         printf(<span class="stringliteral">&quot;NIL right is not NIL\n&quot;</span>);
<a name="l01034"></a>01034         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01035"></a>01035     }
<a name="l01036"></a>01036     <span class="keywordflow">if</span> (!<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>) {
<a name="l01037"></a>01037         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01038"></a>01038     }
<a name="l01039"></a>01039     <span class="keywordflow">if</span> ((<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a> == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (<a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a>)) {
<a name="l01040"></a>01040         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01041"></a>01041     }
<a name="l01042"></a>01042     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>) {
<a name="l01043"></a>01043         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01044"></a>01044     }
<a name="l01045"></a>01045     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l01046"></a>01046         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01047"></a>01047     }
<a name="l01048"></a>01048     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#ad64f17e1e919aa57f8fcd255a3d25ec5">verify</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>) &lt; 0) {
<a name="l01049"></a>01049         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01050"></a>01050     }
<a name="l01051"></a>01051     <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a73410dea30af0b939981d5d41efa9a21">m_count</a> != <a class="code" href="classvoltdb_1_1CompactingMap.html#aaaf9eceb89360101a132154eb4cf79ca">fullCount</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>)) {
<a name="l01052"></a>01052         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01053"></a>01053     }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055     <span class="comment">// verify the sub tree nodes counter</span>
<a name="l01056"></a>01056     <span class="keywordflow">if</span> (hasRank) {
<a name="l01057"></a>01057         <span class="keywordflow">if</span> (<a class="code" href="classvoltdb_1_1CompactingMap.html#a62e59d008a0004c15c4b2bd3ecdb648d">inOrderCounterChecking</a>(<a class="code" href="classvoltdb_1_1CompactingMap.html#aa33cb4622293e99459a289e720bf7718">m_root</a>) &lt; 0) {
<a name="l01058"></a>01058             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01059"></a>01059         }
<a name="l01060"></a>01060     }
<a name="l01061"></a>01061     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01062"></a>01062 }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l01065"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a62e59d008a0004c15c4b2bd3ecdb648d">01065</a> <span class="keywordtype">int</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#a62e59d008a0004c15c4b2bd3ecdb648d">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::inOrderCounterChecking</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *n)<span class="keyword"> const</span>
<a name="l01066"></a>01066 <span class="keyword"></span>{
<a name="l01067"></a>01067     <span class="keywordtype">int</span> res = 0;
<a name="l01068"></a>01068     <span class="keywordflow">if</span> (n != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l01069"></a>01069         <span class="keywordflow">if</span> ((res = <a class="code" href="classvoltdb_1_1CompactingMap.html#a62e59d008a0004c15c4b2bd3ecdb648d">inOrderCounterChecking</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>)) &lt; 0) {
<a name="l01070"></a>01070             <span class="keywordflow">return</span> res;
<a name="l01071"></a>01071         }
<a name="l01072"></a>01072         <span class="comment">// check counter for sub tree nodes</span>
<a name="l01073"></a>01073         int64_t ct = 1;
<a name="l01074"></a>01074         <span class="keywordflow">if</span> (n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l01075"></a>01075             ct += <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>);
<a name="l01076"></a>01076         }
<a name="l01077"></a>01077         <span class="keywordflow">if</span> (n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l01078"></a>01078             ct += <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>);
<a name="l01079"></a>01079         }
<a name="l01080"></a>01080         <span class="keywordflow">if</span> (ct != <a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(n)) {
<a name="l01081"></a>01081             printf(<span class="stringliteral">&quot;node counter is not correct, expected %ld but get %ld\n&quot;</span>, (<span class="keywordtype">long</span>)ct, (<span class="keywordtype">long</span>)<a class="code" href="classvoltdb_1_1CompactingMap.html#ae33f85c65cb682313a900b99b7a2e413">getSubct</a>(n));
<a name="l01082"></a>01082             <span class="keywordflow">return</span> -1;
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085         <span class="keywordflow">if</span> ((res = <a class="code" href="classvoltdb_1_1CompactingMap.html#a62e59d008a0004c15c4b2bd3ecdb648d">inOrderCounterChecking</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>)) &lt; 0) {
<a name="l01086"></a>01086             <span class="keywordflow">return</span> res;
<a name="l01087"></a>01087         }
<a name="l01088"></a>01088     }
<a name="l01089"></a>01089     <span class="keywordflow">return</span> res;
<a name="l01090"></a>01090 }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l01093"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a0738727b5ed1eba9d6a5e85019afb8f0">01093</a> <span class="keywordtype">int</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#ad64f17e1e919aa57f8fcd255a3d25ec5">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::verify</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *n)<span class="keyword"> const</span>
<a name="l01094"></a>01094 <span class="keyword"></span>{
<a name="l01095"></a>01095     <span class="comment">// recursive stopping case</span>
<a name="l01096"></a>01096     <span class="keywordflow">if</span> (n == NULL) {
<a name="l01097"></a>01097         <span class="comment">//TODO: This SHOULD return -1.</span>
<a name="l01098"></a>01098         <span class="keywordflow">return</span> 0; <span class="comment">// This should not happen. All leaves should terminate with &amp;NIL.</span>
<a name="l01099"></a>01099     }
<a name="l01100"></a>01100     <span class="keywordflow">if</span> (n == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>)
<a name="l01101"></a>01101         <span class="keywordflow">return</span> 0;
<a name="l01102"></a>01102 
<a name="l01103"></a>01103     <span class="comment">//printf(&quot;verify -&gt; node %d\n&quot;, N-&gt;value);</span>
<a name="l01104"></a>01104     <span class="comment">//fflush(stdout);</span>
<a name="l01105"></a>01105 
<a name="l01106"></a>01106     <span class="comment">// check children have a valid parent pointer</span>
<a name="l01107"></a>01107     <span class="keywordflow">if</span> ((n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> != n)) {
<a name="l01108"></a>01108         <span class="keywordflow">return</span> -1;
<a name="l01109"></a>01109     }
<a name="l01110"></a>01110     <span class="keywordflow">if</span> ((n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#afb220b54f22fb0e073ead1053cb4f3c1">parent</a> != n)) {
<a name="l01111"></a>01111         <span class="keywordflow">return</span> -1;
<a name="l01112"></a>01112     }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114     <span class="comment">// check for no two consecutive red nodes</span>
<a name="l01115"></a>01115     <span class="keywordflow">if</span> (n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>) {
<a name="l01116"></a>01116         <span class="keywordflow">if</span> ((n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>)) {
<a name="l01117"></a>01117             <span class="keywordflow">return</span> -1;
<a name="l01118"></a>01118         }
<a name="l01119"></a>01119         <span class="keywordflow">if</span> ((n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#a2865009e7d4db8c8d4aaf60113014166">RED</a>)) {
<a name="l01120"></a>01120             <span class="keywordflow">return</span> -1;
<a name="l01121"></a>01121         }
<a name="l01122"></a>01122     }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="comment">// check for strict ordering</span>
<a name="l01125"></a>01125     <span class="keywordflow">if</span> ((n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (<a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>(), n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>()) &lt; 0)) {
<a name="l01126"></a>01126         <span class="keywordflow">return</span> -1;
<a name="l01127"></a>01127     }
<a name="l01128"></a>01128     <span class="keywordflow">if</span> ((n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a> != &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) &amp;&amp; (<a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>(), n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>()) &gt; 0)) {
<a name="l01129"></a>01129         <span class="keywordflow">return</span> -1;
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131 
<a name="l01132"></a>01132     <span class="comment">// recursive step (compare black height)</span>
<a name="l01133"></a>01133     <span class="keywordtype">int</span> leftBH = <a class="code" href="classvoltdb_1_1CompactingMap.html#ad64f17e1e919aa57f8fcd255a3d25ec5">verify</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>);
<a name="l01134"></a>01134     <span class="keywordtype">int</span> rightBH = <a class="code" href="classvoltdb_1_1CompactingMap.html#ad64f17e1e919aa57f8fcd255a3d25ec5">verify</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>);
<a name="l01135"></a>01135     <span class="keywordflow">if</span> (leftBH == -1) {
<a name="l01136"></a>01136         <span class="keywordflow">return</span> -1;
<a name="l01137"></a>01137     }
<a name="l01138"></a>01138     <span class="keywordflow">if</span> (rightBH == -1) {
<a name="l01139"></a>01139         <span class="keywordflow">return</span> -1;
<a name="l01140"></a>01140     }
<a name="l01141"></a>01141     <span class="keywordflow">if</span> (leftBH != rightBH) {
<a name="l01142"></a>01142         <span class="keywordflow">return</span> -1;
<a name="l01143"></a>01143     }
<a name="l01144"></a>01144     <span class="keywordflow">if</span> (n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a8602e9d84e895912c305dcc8cdc5bb0a">color</a> == <a class="code" href="classvoltdb_1_1CompactingMap.html#ab15c597dc1c59e0c13ac5e5fe23a371a">BLACK</a>) {
<a name="l01145"></a>01145         <span class="keywordflow">return</span> leftBH + 1;
<a name="l01146"></a>01146     }
<a name="l01147"></a>01147     <span class="keywordflow">return</span> leftBH;
<a name="l01148"></a>01148 }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l01151"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#aaaf9eceb89360101a132154eb4cf79ca">01151</a> <span class="keywordtype">int</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#aaaf9eceb89360101a132154eb4cf79ca">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::fullCount</a>(<span class="keyword">const</span> <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *n)<span class="keyword"> const</span>
<a name="l01152"></a>01152 <span class="keyword"></span>{
<a name="l01153"></a>01153     <span class="keywordflow">if</span> (n == &amp;<a class="code" href="classvoltdb_1_1CompactingMap.html#ac46aca8dc994e6f683264f25f786fdb0">NIL</a>) {
<a name="l01154"></a>01154         <span class="keywordflow">return</span> 0;
<a name="l01155"></a>01155     }
<a name="l01156"></a>01156     <span class="keywordflow">return</span> <a class="code" href="classvoltdb_1_1CompactingMap.html#aaaf9eceb89360101a132154eb4cf79ca">fullCount</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#af4551ad6ef92208431d050ffd4af4480">left</a>) + <a class="code" href="classvoltdb_1_1CompactingMap.html#aaaf9eceb89360101a132154eb4cf79ca">fullCount</a>(n-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#ac44cb004579de6af7d6610bb4317cca5">right</a>) + 1;
<a name="l01157"></a>01157 }
<a name="l01158"></a>01158 
<a name="l01159"></a>01159 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> KeyValuePair, <span class="keyword">typename</span> Compare, <span class="keywordtype">bool</span> hasRank&gt;
<a name="l01160"></a>01160 <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01161"></a><a class="code" href="classvoltdb_1_1CompactingMap.html#a83aec764bd6dceb39a371df6c882aa33">01161</a> <a class="code" href="classvoltdb_1_1CompactingMap.html#a83aec764bd6dceb39a371df6c882aa33">CompactingMap&lt;KeyValuePair, Compare, hasRank&gt;::compareKeyRegardlessOfPointer</a>(<span class="keyword">const</span> Key&amp; key, <a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html">TreeNode</a> *node)<span class="keyword"> const</span>
<a name="l01162"></a>01162 <span class="keyword"></span>{
<a name="l01163"></a>01163     <span class="comment">// assume key&apos;s pointer field is NULL, if there is a pointer field in key</span>
<a name="l01164"></a>01164     <span class="keyword">const</span> <span class="keywordtype">void</span> *tmp = node-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>.setPointerValue(NULL);
<a name="l01165"></a>01165     <span class="keywordtype">int</span> rv = <a class="code" href="classvoltdb_1_1CompactingMap.html#a47d9f52fc749e51a29969cc33da2db32">m_comper</a>(key, node-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a0979b406329f710da88ee3351389abc6">key</a>());
<a name="l01166"></a>01166     node-&gt;<a class="code" href="structvoltdb_1_1CompactingMap_1_1TreeNode.html#a225e2defcbedc502615f2effeb812f09">kv</a>.setPointerValue(tmp);
<a name="l01167"></a>01167     <span class="keywordflow">return</span> rv;
<a name="l01168"></a>01168 }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170 } <span class="comment">// namespace voltdb</span>
<a name="l01171"></a>01171 
<a name="l01172"></a>01172 <span class="preprocessor">#endif // COMPACTINGMAP_H_</span>
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"/><address style="text-align: right;"><small>Generated on 2 Oct 2014 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
